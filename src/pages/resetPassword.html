<!DOCTYPE html>
<html>
  <head>
    <title>Histo Atlas - Re Initialisation du mot de passe</title>
    <link rel="icon" type="image/png" href="../img/icon.png" />
  </head>
  <body>

  <script type="text/javascript" src="../node_modules/jquery/dist/jquery.min.js"></script>

  <link rel="stylesheet" href="../index.css" />

  <p><a href="../index.html">Retour au menu</a></p>

  <h4>Changer le mot de passe : </h4>
  <label for="new-password">Nouveau mot de passe : </label><br/><input id="new-password" type="password" style="width: 250px;"></input><br/><br/>
  <label for="confirm-password">Confirmer le mot de passe : </label><br/><input id="confirm-password" type="password" style="width: 250px;"></input><br/><br/>
  <button id="change-password">Modifier le mot de passe</button><br/>


  <script type="text/javascript" src="../config/config.js"></script>

  <script>

    Config.load(true).then((config) =>
    {
      let urlParams = getUrlParams();

      $.ajax({
        url: config.serverUrl + "/api/user/resetPassword/" + urlParams["token"],
        method: "GET",
        contentType: "application/json",
        success: (response) => {

          $("#change-password").click(function() 
          {
            let newPassWord = $("#new-password").val();
            let confirmPassWord = $("#confirm-password").val();

            if(newPassWord != "")
            {
              if(newPassWord == confirmPassWord)
              {
                $.ajax({
                  url: config.serverUrl + "/api/user/resetPassword",
                  method: "POST",
                  contentType: "application/json",
                  data: JSON.stringify({password : newPassWord, token : urlParams["token"]}),
                  success: (response) => {

                    alert("Votre mot de passe a été modifié");
                    window.location.href = "../index.html";
                  },
                  error: (err) => {
                    if(err.responseJSON)
                    {
                      alert("Impossible de changer le mot de passe : " + err.responseJSON.error);
                    }
                    else
                    {
                      alert("Impossible de changer le mot de passe");
                    }
                    window.location.href = "../index.html";
                  }
                });
              }
              else
              {
                alert("Les deux mots de passe entrés ne sont pas identiques");
              }
            }
            else
            {
              alert("Le mot de passe est vide");
            }
          });
        },
        error: (err) => {
          alert("Impossible de changer le mot de passe : " + err.responseJSON.error);
          window.location.href = "../index.html";
        }
      });
    });

    /**
     * get params in the address bar
     * return {String[]}             Array of params get in address bar 
     */
    function getUrlParams()
    {
      // Get ars values of address bar
      var args = location.search.substr(1).split(/&/);
      var argsValues = [];

      for(var i =0; i < args.length; i++)
      {
        var tmp = args[i].split(/=/);
        if (tmp[0] != "") {
            argsValues[decodeURIComponent(tmp[0])] = decodeURIComponent(tmp.slice(1).join("").replace("+", " "));
        }
      }

      return argsValues;
    }


  </script>

  </body>
</html>